"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4279],{3159:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var t=n(4848),i=n(8453);const a={},l="3.1 Querying Files",r={id:"Databricks Certified Data Engineer Associate - Preparation/ELT with Spark SQL and Python/3.1 Querying Files",title:"3.1 Querying Files",description:"- [ ] In this video, we will talk about querying files in Databricks",source:"@site/docs/Databricks Certified Data Engineer Associate - Preparation/3. ELT with Spark SQL and Python/3.1 Querying Files.md",sourceDirName:"Databricks Certified Data Engineer Associate - Preparation/3. ELT with Spark SQL and Python",slug:"/Databricks Certified Data Engineer Associate - Preparation/ELT with Spark SQL and Python/3.1 Querying Files",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/ELT with Spark SQL and Python/3.1 Querying Files",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Databricks Certified Data Engineer Associate - Preparation/3. ELT with Spark SQL and Python/3.1 Querying Files.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"2.9 Working with Views (HandsOn)",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/Databricks Lakehouse Platform/2.9 Working with Views (HandsOn)"},next:{title:"3.2 Query Files (Hands On)",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/ELT with Spark SQL and Python/3.2 Query Files (HandsOn)"}},o={},c=[{value:"How to extract data directly from files",id:"how-to-extract-data-directly-from-files",level:2},{value:"How to use additional file options with the USING option",id:"how-to-use-additional-file-options-with-the-using-option",level:2},{value:"How to create a table from a CSV file",id:"how-to-create-a-table-from-a-csv-file",level:2},{value:"How to create a table using JDBC connection",id:"how-to-create-a-table-using-jdbc-connection",level:2},{value:"Limitation of tables from external data sources",id:"limitation-of-tables-from-external-data-sources",level:2}];function d(e){const s={admonition:"admonition",code:"code",h1:"h1",h2:"h2",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"31-querying-files",children:"3.1 Querying Files"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","In this video, we will talk about querying files in Databricks",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"how-to-extract-data-directly-from-files",children:"How to extract data directly from files"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","You will learn how to extract data directly from files using Spark SQL and different methods to review raw files contents",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We will see how to use the Spark SQL to configure options for extracting data from external sources and how to use ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"CTAS"})})," statements to create Delta Lake tables",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","To query file content, we can simply use a SELECT statement. ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"SELECT * FROM"})})," a file format, and we specify the file path"]}),"\n",(0,t.jsxs)(s.admonition,{type:"info",children:[(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"SELECT * FROM file_format.`/path/to/file`\n"})}),(0,t.jsxs)(s.p,{children:["Make a special note of the use of back ticks (",(0,t.jsx)(s.strong,{children:"`"}),") and not single quotes around the path",(0,t.jsx)("br",{}),"\nThis work well with self-describing formats that have well-defined schema like JSON and parquet"]})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","It is not very useful with non-describing formats like CSV",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","A path file could be a single file. Or we can use wildcard (",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"*"})}),") character to read multiple simultaneously. Or simply reading the whole directory"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.p,{children:"Assuming that all of the files in the directory have the same format and schema"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here is an example to query a JSON file"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"SELECT * FROM json.`/path/file_name.json`\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","When working with text-based files which include ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"JSON"})}),", ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"CSV"})}),", ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"TSV"})})," and ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"TXT"})}),' format, You can use the "text" format to extract data as raw strings']}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"SELECT * FROM text.`/path/to/file`\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","This can be useful when input data could be corrupted. In this case, we extract the data as raw string and we apply custom text parsing functions to extract values from text files",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","In some cases, we need the binary representation of files content, for example, when dealing with images and unstructured data",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here we can use simply ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"binaryFile"})})," as a format"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"SELECT * FROM binaryFile.`/path/to/file`\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","After extracting data from external data sources, we need to load them into the Lakehouse which ensures that all of the benefits of Databricks platform can be fully leveraged",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","To load data from files into Delta tables. We use ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"CTAS"})})," statements, which is ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"CREATE TABLE AS SELECT"})})," query"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",metastring:"{2}",children:"CREATE TABLE table_name\nAS SELECT * FROM file_format.`/path/to/file`\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here we are querying data from files directly. ",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","CTAS statements inferior schema information from query results and do not support manual schema declaration"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.p,{children:"This means the CTAS statements are useful for external data injection from sources with well-defined schema such as parquet files and tables"})}),"\n",(0,t.jsx)(s.admonition,{type:"warning",children:(0,t.jsx)(s.p,{children:"CTAS statements also do not support specifying additional file options. And this is why this statement presents significant limitation when trying to ingest data from CSV files"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"how-to-use-additional-file-options-with-the-using-option",children:"How to use additional file options with the USING option"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We need another solution that supports options. This solution is the regular ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"CREATE TABLE"})})," statement, but with the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"USING"})})," keyword",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","By adding the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"USING"})})," keyword, we specify the external data source type, for example CSV format and with any additional options"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",metastring:"{3}",children:"CREATE TABLE table_name (\n    column_name1 col_type1\n) USING data_source\nOPTIONS (\n    key1=val1, \n    key2=val2\n)\nLOCATION = path\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","You need to specify a location to where these files are stored"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",metastring:"{8}",children:"CREATE TABLE table_name (\n    column_name1 col_type1\n) USING data_source\nOPTIONS (\n    key1=val1, \n    key2=val2\n)\nLOCATION = path\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","With this command, we are always creating an external table",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","The table here is just a reference to the files. Unlike with CTAS statements, here there is no data moving during table creation",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We are just pointing to files stored in an external location"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.p,{children:"These files are kept in its original format, which means we are creating here a non-Delta table"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"how-to-create-a-table-from-a-csv-file",children:"How to create a table from a CSV file"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here is an example of creating a table using CSV external source",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We are pointing to CSV files exist in an external location",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We are specifying the options for reading the files"]}),"\n",(0,t.jsxs)(s.admonition,{type:"info",children:[(0,t.jsxs)(s.p,{children:["Like the fact that there is a ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"header"})})," present in the files and the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"delimiter"})})," is a semicolon (",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:";"})}),")"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",metastring:"{5-6}",children:'CREATE TABLE table_name (\n    col_name1 col_type1\n) USING CSV\nOPTIONS (\n    header="true",\n    delimiter=";"\n) LOCATION = path\n'})})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We are providing the location to these CSV files"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",metastring:"{7}",children:'CREATE TABLE table_name (\n    col_name1 col_type1\n) USING CSV\nOPTIONS (\n    header="true",\n    delimiter=";"\n) LOCATION = path\n'})})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"how-to-create-a-table-using-jdbc-connection",children:"How to create a table using JDBC connection"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Another example is to create a table using JDBC connection to refer to data in an external SQL database",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We provide the necessary ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIONS"})})," like the connection string (",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"url"})}),"), the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"username"})}),", and the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"password"})})," for this database, and of course, the database table (",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"dbtable"})}),") containing the data"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",metastring:"{4-9}",children:'CREATE TABLE table_name (\n    col_name1 col_type1\n) USING JDBC\nOPTIONS (\n    url="jdbc:sqlite://hostname:port",\n    dbtable="database.table",\n    user="username",\n    password="pwd"\n)\n'})})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"limitation-of-tables-from-external-data-sources",children:"Limitation of tables from external data sources"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","A table with external data source has a limitation",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","It is not a Delta table. It means the performance and the features of Delta Lake are no more guaranteed, like time travel feature, and the guarantee that we are always reading the most recent version of the data",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","If you are referring to a huge database table, this also can cause performance issues"]}),"\n",(0,t.jsxs)(s.admonition,{type:"info",children:[(0,t.jsxs)(s.p,{children:["Fortunately, we have a solution for this limitation. The solution is simply to create a temporary view, referring to the external data source, and then query this temporary view to create a table using CTAS statements",(0,t.jsx)("br",{})]}),(0,t.jsxs)(s.p,{children:["In this way, we are extracting the data from the external data source and load it in a Delta table",(0,t.jsx)("br",{})]}),(0,t.jsxs)(s.p,{children:["As you can see, with ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"CTAS"})})," statement, you can not only query files, but you can query any object like a temporary view in this case"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"CREATE TEMP VIEW temp_view_name (\n    col_name1 col_type1\n) USING data_source\nOPTIONS (\n    key1=val1, \n    key2=val2\n);\n\nCREATE TABLE table_name\nAS SELECT * FROM temp_view_name\n"})})]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>r});var t=n(6540);const i={},a=t.createContext(i);function l(e){const s=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function r(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(a.Provider,{value:s},e.children)}}}]);