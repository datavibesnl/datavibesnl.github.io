"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[272],{3914:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var s=n(4848),i=n(8453);const a={},d="5.2 Change Data Capture",r={id:"Databricks Certified Data Engineer Associate - Preparation/Production Pipelines/5.2 Change Data Capture",title:"5.2 Change Data Capture",description:"- [ ] In this lecture, we will talk about change data capture",source:"@site/docs/Databricks Certified Data Engineer Associate - Preparation/5. Production Pipelines/5.2 Change Data Capture.md",sourceDirName:"Databricks Certified Data Engineer Associate - Preparation/5. Production Pipelines",slug:"/Databricks Certified Data Engineer Associate - Preparation/Production Pipelines/5.2 Change Data Capture",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/Production Pipelines/5.2 Change Data Capture",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Databricks Certified Data Engineer Associate - Preparation/5. Production Pipelines/5.2 Change Data Capture.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"5.1 Delta Live Tables (Hands On)",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/Production Pipelines/5.1 Delta Live Tables Hands On"},next:{title:"5.3 Processing CDC Feed with DLT (Hands On)",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/Production Pipelines/5.3 Processing CDC Feed with DLT Hands On"}},l={},c=[{value:"Change Data Capture",id:"change-data-capture",level:2},{value:"Row-level changes",id:"row-level-changes",level:3},{value:"CDC Feed",id:"cdc-feed",level:2},{value:"Features of the <strong><code>APPLY CHANGES INTO</code></strong> command",id:"features-of-the-apply-changes-into-command",level:2},{value:"Disadvantage of APPLY CHANGES INTO",id:"disadvantage-of-apply-changes-into",level:2}];function o(e){const t={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"52-change-data-capture",children:"5.2 Change Data Capture"}),"\n",(0,s.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","In this lecture, we will talk about change data capture",(0,s.jsx)("br",{})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","You will understand what is change data capture, and you will learn how this can be processed in Data Live Tables"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"change-data-capture",children:"Change Data Capture"}),"\n",(0,s.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ",(0,s.jsx)(t.strong,{children:"Change Data Capture"})," or ",(0,s.jsx)(t.strong,{children:"CDC"})," refers to the process of identifying and capturing changes made to data in the data source, and then delivering those changes to the target"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"row-level-changes",children:"Row-level changes"}),"\n",(0,s.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Those changes could be obviously new records to be inserted from the source to the target",(0,s.jsx)("br",{})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Updated records in the source that need to be reflected in the target",(0,s.jsx)("br",{})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Deleted records in the source that must be deleted in the target"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"cdc-feed",children:"CDC Feed"}),"\n",(0,s.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Changes are logged at the source as events that contain both the data of the records along with metadata information"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"This metadata indicates whether the specified record was inserted, updated or deleted in addition to a version number or timestamp indicating the order in which changes happened"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Here's an example of CDC events need to be applied on our target table"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"France, for example has two records, so we need to apply the most recent change. Canada need to be deleted, so we don't need to send all the data of the record. Lastly, USA and India are new records need to be inserted"})}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Country ID"}),(0,s.jsx)(t.th,{children:"Country"}),(0,s.jsx)(t.th,{children:"Vaccination Rate"}),(0,s.jsx)(t.th,{children:"sequence"}),(0,s.jsx)(t.th,{children:"operation"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"FR"}),(0,s.jsx)(t.td,{children:"France"}),(0,s.jsx)(t.td,{children:"0.74"}),(0,s.jsx)(t.td,{children:"2022-11-01 07:00"}),(0,s.jsx)(t.td,{children:"UPDATE"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"FR"}),(0,s.jsx)(t.td,{children:"France"}),(0,s.jsx)(t.td,{children:"0.75"}),(0,s.jsx)(t.td,{children:"2022-11-01 08:00"}),(0,s.jsx)(t.td,{children:"UPDATE"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"CA"}),(0,s.jsx)(t.td,{}),(0,s.jsx)(t.td,{}),(0,s.jsx)(t.td,{children:"2022-11-01 00:00"}),(0,s.jsx)(t.td,{children:"DELETE"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"US"}),(0,s.jsx)(t.td,{children:"USA"}),(0,s.jsx)(t.td,{children:"0.5"}),(0,s.jsx)(t.td,{children:"2022-11-01 00:00"}),(0,s.jsx)(t.td,{children:"INSERT"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"IN"}),(0,s.jsx)(t.td,{children:"India"}),(0,s.jsx)(t.td,{children:"0.66"}),(0,s.jsx)(t.td,{children:"2022-11-01 00:00"}),(0,s.jsx)(t.td,{children:"INSERT"})]})]})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Here we see the changes applied on our target table",(0,s.jsx)("br",{})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","We don't see the record of Canada as it has been deleted"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"Such a CDC feed could be received from the source as a data stream or simply in JSON files, for example"})}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Country ID"}),(0,s.jsx)(t.th,{children:"Country"}),(0,s.jsx)(t.th,{children:"Vaccination Rate"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"FR"}),(0,s.jsx)(t.td,{children:"France"}),(0,s.jsx)(t.td,{children:"0.75"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"US"}),(0,s.jsx)(t.td,{children:"USA"}),(0,s.jsx)(t.td,{children:"0.5"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"IN"}),(0,s.jsx)(t.td,{children:"India"}),(0,s.jsx)(t.td,{children:"0.66"})]})]})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Delta Live Tables supports CDC feed processing using the ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"APPLY CHANGES INTO"})})," command"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",metastring:"{1}",children:'APPLY CHANGES INTO LIVE.target_table\nFROM STREAM(\n    LIVE.cdc_feed_table\n) KEYS (\n    key_field\n) APPLY AS DELETE WHEN operation_field = "DELETE"\nSEQUENCE BY sequence_field\nCOLUMNS *\n'})})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","It is the target table into which the changes need to be applied. ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"FROM"})})," a CDC feed table specified as a streaming source. ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"KEYS"})})," is where you identify the primary key fields. If the key exists in the target table, the record will be updated"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",metastring:"{5}",children:'APPLY CHANGES INTO LIVE.target_table\nFROM STREAM(\n    LIVE.cdc_feed_table\n) KEYS (\n    key_field\n) APPLY AS DELETE WHEN operation_field = "DELETE"\nSEQUENCE BY sequence_field\nCOLUMNS *\n'})})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","With the ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"APPLY AS DELETE WHEN"})})," condition, you specify that records where the operation field is ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"DELETE"})})," should be deleted"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",metastring:"{6}",children:'APPLY CHANGES INTO LIVE.target_table\nFROM STREAM(\n    LIVE.cdc_feed_table\n) KEYS (\n    key_field\n) APPLY AS DELETE WHEN operation_field = "DELETE"\nSEQUENCE BY sequence_field\nCOLUMNS *\n'})})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"SEQUENCE BY"})}),", where do you specify the sequence field for ordering how operation should be applied"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",metastring:"{7}",children:'APPLY CHANGES INTO LIVE.target_table\nFROM STREAM(\n    LIVE.cdc_feed_table\n) KEYS (\n    key_field\n) APPLY AS DELETE WHEN operation_field = "DELETE"\nSEQUENCE BY sequence_field\nCOLUMNS *\n'})})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","You indicate the list of fields that should be added to the target table"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sql",metastring:"{8}",children:'APPLY CHANGES INTO LIVE.target_table\nFROM STREAM(\n    LIVE.cdc_feed_table\n) KEYS (\n    key_field\n) APPLY AS DELETE WHEN operation_field = "DELETE"\nSEQUENCE BY sequence_field\nCOLUMNS *\n'})})}),"\n",(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsxs)(t.p,{children:["Note here the target Delta Live Table need to be already created before executing the ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"APPLY CHANGES INTO"})})," command"]})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.h2,{id:"features-of-the-apply-changes-into-command",children:["Features of the ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"APPLY CHANGES INTO"})})," command"]}),"\n",(0,s.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","It automatically orders late arriving records using the user-provided sequencing key"]}),"\n",(0,s.jsxs)(t.admonition,{type:"info",children:[(0,s.jsxs)(t.p,{children:["This pattern ensures that if any records arrive out of order, down stream result can be properly re-computed to reflect the updates",(0,s.jsx)("br",{})]}),(0,s.jsx)(t.p,{children:"It also ensures that when records are deleted from a source table, these values are no longer reflected in tables later in the pipeline"})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","The default behavior for insert and update operation is to upsert the CDC events into the target table"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"That means it updates any rows in the target table that match the specified key or insert new records when a matching record does not exist in the target table"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Optional handling for delete events can be specified with the ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"APPLY AS DELETE WHEN"})})," condition",(0,s.jsx)("br",{})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","You can specify one or many fields as the primary key for a table",(0,s.jsx)("br",{})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","The ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"EXCEPT"})})," keyword can be added to specify columns to ignore",(0,s.jsx)("br",{})]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","You can choose whether to store records as slowly changing dimension, type 1 or type 2 ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"APPLY CHANGES INTO"})})," defaults to creating a type 1 slowly changing dimension table, meaning that each unique key will have at most one record, and that the updates would overwrite the original information"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"disadvantage-of-apply-changes-into",children:"Disadvantage of APPLY CHANGES INTO"}),"\n",(0,s.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(t.li,{className:"task-list-item",children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Since data is being updated and delete in the target table, this breaks the append-only requirements for streaming table sources"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"That means we will no longer be able to use this updated table as a streaming source later in the next layer"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>d,x:()=>r});var s=n(6540);const i={},a=s.createContext(i);function d(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);