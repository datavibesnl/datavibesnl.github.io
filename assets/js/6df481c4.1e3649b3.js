"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6655],{9083:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>d});var t=n(4848),i=n(8453);const a={},l="2.4 Apply Advanced Delta Features (Hands",r={id:"Databricks Certified Data Engineer Associate - Preparation/Databricks Lakehouse Platform/2.4 Apply Advanced Delta Features",title:"2.4 Apply Advanced Delta Features (Hands",description:"- [ ] In this notebook, we will see some advanced concepts in Delta Lake, such as the time travel feature and we will see OPTIMIZE and VACUUM command",source:"@site/docs/Databricks Certified Data Engineer Associate - Preparation/2. Databricks Lakehouse Platform/2.4 Apply Advanced Delta Features.md",sourceDirName:"Databricks Certified Data Engineer Associate - Preparation/2. Databricks Lakehouse Platform",slug:"/Databricks Certified Data Engineer Associate - Preparation/Databricks Lakehouse Platform/2.4 Apply Advanced Delta Features",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/Databricks Lakehouse Platform/2.4 Apply Advanced Delta Features",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Databricks Certified Data Engineer Associate - Preparation/2. Databricks Lakehouse Platform/2.4 Apply Advanced Delta Features.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"2.3 Advanced Delta Lake Features",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/Databricks Lakehouse Platform/2.3 Advanced Delta Lake Features"},next:{title:"2.5 Relational entities",permalink:"/docs/Databricks Certified Data Engineer Associate - Preparation/Databricks Lakehouse Platform/2.5 Relational entities"}},o={},d=[{value:"How to read the history of a table",id:"how-to-read-the-history-of-a-table",level:2},{value:"How to use the Time Travel feature with <strong>VERSION AS OF</strong>",id:"how-to-use-the-time-travel-feature-with-version-as-of",level:2},{value:"How to restore data with the <strong>RESTORE</strong> command",id:"how-to-restore-data-with-the-restore-command",level:2},{value:"How to compact small files with <strong>OPTIMIZE</strong> and z-order indexing with <strong>ZORDER BY</strong>",id:"how-to-compact-small-files-with-optimize-and-z-order-indexing-with-zorder-by",level:2}];function c(e){const s={admonition:"admonition",code:"code",h1:"h1",h2:"h2",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"24-apply-advanced-delta-features-hands",children:"2.4 Apply Advanced Delta Features (Hands"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","In this notebook, we will see some advanced concepts in Delta Lake, such as the time travel feature and we will see ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," and ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"VACUUM"})})," command"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"how-to-read-the-history-of-a-table",children:"How to read the history of a table"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Let us review again our table history"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"DESCRIBE HISTORY employees\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here we can see the 3 versions of our table"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.h2,{id:"how-to-use-the-time-travel-feature-with-version-as-of",children:["How to use the Time Travel feature with ",(0,t.jsx)(s.strong,{children:"VERSION AS OF"})]}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","In Delta Lake, we can easily query previous versions of our table, and this feature of time travel is possible thanks to those extra data files that had been marked as removed in our transaction log",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Let's say we want to access our data before the update operation, which is version number 1",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We can simply use ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"SELECT"})})," query with ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"VERSION AS OF"})})," keyword, and we specify the version number, in our case it is version 1"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",metastring:"{2}",children:"SELECT * FROM employees\nVERSION AS OF 1\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here we can see our data before the update operation"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["Another alternative syntax is to use ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"@v"})})," followed by the version number"]})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.h2,{id:"how-to-restore-data-with-the-restore-command",children:["How to restore data with the ",(0,t.jsx)(s.strong,{children:"RESTORE"})," command"]}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Imagine this scenario, we deleted our data and we need to restore them"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"DELETE FROM employees\n"})})}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsx)(s.p,{children:"Here, -1 means that all data has been removed"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Let us confirm this. So, our table data has been indeed removed ",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We can simply roll back to a previous version before deletion using ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"RESTORE TABLE"})})," command"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"RESTORE TABLE employees TO VERSION AS OF 2\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Let us explore what really happened in our table"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"DESCRIBE HISTORY employees\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","As you can see, the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"RESTORE"})})," command has been recorded as a transaction"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.h2,{id:"how-to-compact-small-files-with-optimize-and-z-order-indexing-with-zorder-by",children:["How to compact small files with ",(0,t.jsx)(s.strong,{children:"OPTIMIZE"})," and z-order indexing with ",(0,t.jsx)(s.strong,{children:"ZORDER BY"})]}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Let us now talk about the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," command and how to compact small files and do Z-order indexing ",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Since Spark work in parallel, you usually end up by writing too many small files. Having many small data files negatively affect the performance of the Delta Table"]}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsx)(s.p,{children:"In our case, we have 4 small data files"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","To resolve this issue, we can use ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," command that combines files toward an optimal size ",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," will replace existing data files by combining records and rewriting the results"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"OPTIMIZE employees ZORDER BY id\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here, we can see that our 4 data files have been soft deleted, and a new file has been added that compacts those 4 files. ",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","In addition, you may notice that we added the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"ZORDER"})})," indexing with our ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," command. Z-order indexing speeds up data retrieval when filtering on provided fields, by grouping data with similar values within the same data files"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["In our case, we do z-order by the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"id"})})," column. However, on such a small data set, it does not provide any benefit"]})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Let us confirm the output of the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," command by running ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"DESCRIBE DETAIL"})})," on our table"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"DESCRIBE DETAIL employees\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here, we can see that the number of files in the current version is only one. Let us see how to ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," operation has been recorded in our table history"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"DESCRIBE HISTORY employees\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","As expected, ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," command created another version in our table, meaning that version 5 is the most recent version of our table ",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Let us now explore the data files in our table directory"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sh",children:"%fs ls 'dbfs:/user/hive/warehouse/employees'\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Here, we can see that there are 7 data files. But, we know, that our current table version referencing only one file after the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"OPTIMIZE"})})," operation. It means that other data files are unused files, and we can simply clean them up ",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We can manually remove old data files using the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"VACUUM"})})," command. Let run this command and see what happens"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"VACUUM employees\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","If we check the table directory again, we see that nothing happened. The data files are still there. This is because we need to specify a retention period, and by default this retention period is 7 days"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["That means that ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"VACUMM"})})," operation will prevent us from deleting files than 7 days old, just to ensure that no long running operations are still referencing any of the files to be deleted"]})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","If we try to execute ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"VACUUM"})})," command with a retention of 0 hour for keeping only the current version, this will not work because, the default threshold is 7 days"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"VACUUM employees RETAIN 0 HOURS\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","In this demo, we will do a work around for demonstration purposes only"]}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsx)(s.p,{children:"You should not do this in production"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","The idea is to turn off the retention duration check"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sh",children:"SET spark.databricks.delta.retentionDurationCheck.enabled = false;\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We can run our ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"VACUUM"})})," command",(0,t.jsx)("br",{})]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:"VACUUM employees RETAIN 0 HOURS\n"})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Let us explore again the table directory"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sh",children:'%fs ls "dbfs:/user/hive/warehouse/employees"\n'})})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Files have been successfully deleted. 6 data files have been removed"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.p,{children:"Those files were really useful for Delta Lake time travel feature"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We are no longer able to access old data versions",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We can easily confirm this by querying an old table version",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","We got here a file not found exception, because the data files for this version no longer exist",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Finally, let us permanently delete the table with its data from the Lakehouse",(0,t.jsx)("br",{})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","For this, we use the ",(0,t.jsx)(s.strong,{children:(0,t.jsx)(s.code,{children:"DROP TABLE"})})," command, like in SQL. The table has been successfully deleted",(0,t.jsx)("br",{})]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>r});var t=n(6540);const i={},a=t.createContext(i);function l(e){const s=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function r(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(a.Provider,{value:s},e.children)}}}]);